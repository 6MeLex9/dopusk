<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–í–ú - Web/WASM –≤–µ—Ä—Å–∏—è (Pyodide)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            color: white;
            padding: 25px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .panel {
            padding: 25px;
            border-bottom: 2px solid #eee;
        }

        textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 15px 0;
            resize: vertical;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .output-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 25px;
        }

        .output-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #6a11cb;
        }

        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 250px;
            overflow-y: auto;
        }

        .status {
            padding: 15px;
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            margin: 10px 0;
            border-radius: 4px;
        }

        .footer {
            background: #f1f3f5;
            padding: 20px;
            text-align: center;
            color: #666;
            border-top: 1px solid #dee2e6;
        }

        @media (max-width: 768px) {
            .output-panel {
                grid-template-columns: 1fr;
            }

            .buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì –£—á–µ–±–Ω–∞—è –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ú–∞—à–∏–Ω–∞</h1>
            <p class="subtitle">Web/WASM –≤–µ—Ä—Å–∏—è –Ω–∞ Pyodide (Python –≤ –±—Ä–∞—É–∑–µ—Ä–µ)</p>
        </header>

        <div class="panel">
            <h2>–ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞ –∞—Å—Å–µ–º–±–ª–µ—Ä–µ:</h2>
            <textarea id="codeEditor" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–∞ –∞—Å—Å–µ–º–±–ª–µ—Ä–µ –£–í–ú...">
; –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –£–í–ú
LOAD 862, 19     ; –ó–∞–≥—Ä—É–∑–∏—Ç—å 862 –≤ —Ä–µ–≥–∏—Å—Ç—Ä 19
LOAD 12345, 60   ; –ó–∞–≥—Ä—É–∑–∏—Ç—å 12345 –≤ —Ä–µ–≥–∏—Å—Ç—Ä 60
STORE 200, 60    ; –ó–∞–ø–∏—Å–∞—Ç—å R60 –≤ –ø–∞–º—è—Ç—å –ø–æ –∞–¥—Ä–µ—Å—É 200
LOAD 0x12345678, 20  ; –¢–µ—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
LOAD 4, 21       ; –°–¥–≤–∏–≥ = 4
STORE 100, 21    ; –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–¥–≤–∏–≥ –≤ –ø–∞–º—è—Ç—å
LOAD 100, 22     ; –ê–¥—Ä–µ—Å —Å–¥–≤–∏–≥–∞ –≤ R22
ROTR 20, 22      ; –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π —Å–¥–≤–∏–≥</textarea>

            <div class="status" id="status">
                ‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pyodide... –ó–∞–≥—Ä—É–∑–∫–∞ Python —Å—Ä–µ–¥—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
            </div>

            <div class="buttons">
                <button id="runBtn" onclick="runProgram()" disabled>
                    ‚ñ∂Ô∏è –ê—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
                </button>
                <button onclick="loadExample()">
                    üìã –ü—Ä–∏–º–µ—Ä –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
                </button>
                <button onclick="clearAll()">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>

        <div class="output-panel">
            <div class="output-section">
                <h3>–†–µ–≥–∏—Å—Ç—Ä—ã (–Ω–µ–Ω—É–ª–µ–≤—ã–µ):</h3>
                <pre id="registersOutput">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</pre>
            </div>

            <div class="output-section">
                <h3>–ü–∞–º—è—Ç—å (–Ω–µ–Ω—É–ª–µ–≤—ã–µ):</h3>
                <pre id="memoryOutput">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</pre>
            </div>

            <div class="output-section">
                <h3>–ë–∞–π—Ç–∫–æ–¥ –∏ –ª–æ–≥–∏:</h3>
                <pre id="logOutput">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</pre>
            </div>
        </div>

        <div class="footer">
            <p>–£–í–ú Web/WASM –≤–µ—Ä—Å–∏—è | Pyodide v0.24.1 | Python 3.10 –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
            <p>–í—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ —á–µ—Ä–µ–∑ WebAssembly</p>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è Pyodide
        let pyodide;
        let pythonCodeLoaded = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pyodide
        async function initPyodide() {
            try {
                document.getElementById('status').innerHTML =
                    '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ Pyodide (Python –≤ WASM)... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.';

                // –ó–∞–≥—Ä—É–∂–∞–µ–º Pyodide
                pyodide = await loadPyodide();

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã
                document.getElementById('status').innerHTML =
                    '‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python...';

                await pyodide.loadPackage(["micropip"]);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—à Python –∫–æ–¥
                document.getElementById('status').innerHTML =
                    '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞ –£–í–ú...';

                await loadPythonCode();

                document.getElementById('status').innerHTML =
                    '‚úÖ Pyodide –∑–∞–≥—Ä—É–∂–µ–Ω! Python 3.10 –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.';
                document.getElementById('runBtn').disabled = false;

            } catch (error) {
                document.getElementById('status').innerHTML =
                    `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Pyodide: ${error.message}`;
                console.error(error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ Python –∫–æ–¥–∞ –£–í–ú
        async function loadPythonCode() {
            const pythonCode = `
import json

class UVMWeb:
    def __init__(self):
        self.registers = [0] * 64
        self.memory = [0] * 2048

    def parse_line(self, line):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ –∞—Å—Å–µ–º–±–ª–µ—Ä–∞"""
        line = line.strip()
        if not line or line.startswith(';'):
            return None

        parts = line.split()
        mnemonic = parts[0].upper()

        commands = {'LOAD': 84, 'READ': 223, 'STORE': 9, 'ROTR': 213}

        if mnemonic not in commands:
            raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {mnemonic}")

        args = []
        for part in parts[1:]:
            part = part.replace(',', '')
            if part.startswith('0x'):
                args.append(int(part, 16))
            else:
                args.append(int(part))

        if len(args) == 2:
            b, c = args
        else:
            b, c = args[0], 0

        return mnemonic, commands[mnemonic], b, c

    def execute_command(self, a, b, c):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã"""
        if a == 84:    # LOAD
            if 0 <= c < 64:
                self.registers[c] = b
        elif a == 223: # READ
            if 0 <= c < 64:
                addr = self.registers[c]
                if 0 <= addr < len(self.memory):
                    if 0 <= b < 64:
                        self.registers[b] = self.memory[addr]
        elif a == 9:   # STORE
            if 0 <= c < 64:
                value = self.registers[c]
                if 0 <= b < len(self.memory):
                    self.memory[b] = value
        elif a == 213: # ROTR
            if 0 <= b < 64 and 0 <= c < 64:
                addr = self.registers[c]
                if 0 <= addr < len(self.memory):
                    shift = self.memory[addr] & 0x1F
                    value = self.registers[b]
                    if shift > 0:
                        mask = 0xFFFFFFFF
                        result = ((value >> shift) | (value << (32 - shift))) & mask
                    else:
                        result = value
                    self.registers[b] = result

    def run(self, program_text):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
        # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        self.registers = [0] * 64
        self.memory = [0] * 2048

        logs = []
        lines = program_text.strip().split('\\n')

        for line_num, line in enumerate(lines, 1):
            try:
                parsed = self.parse_line(line)
                if parsed is None:
                    continue

                mnemonic, a, b, c = parsed
                self.execute_command(a, b, c)

                logs.append(f"–°—Ç—Ä–æ–∫–∞ {line_num}: {mnemonic} B={b}, C={c}")

            except Exception as e:
                logs.append(f"–û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ {line_num}: {str(e)}")

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        registers_result = {}
        for i, val in enumerate(self.registers):
            if val != 0:
                registers_result[f'R{i:02d}'] = val

        memory_result = {}
        for i in range(min(200, len(self.memory))):
            if self.memory[i] != 0:
                memory_result[f'0x{i:04X}'] = self.memory[i]

        return {
            'registers': registers_result,
            'memory': memory_result,
            'logs': logs,
            'success': True
        }

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –£–í–ú
uvm_web = UVMWeb()
`;

            await pyodide.runPythonAsync(pythonCode);
            pythonCodeLoaded = true;
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        async function runProgram() {
            if (!pythonCodeLoaded) {
                alert('Pyodide –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
                return;
            }

            const code = document.getElementById('codeEditor').value;

            document.getElementById('status').innerHTML =
                '‚è≥ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ (WebAssembly)...';

            try {
                // –í—ã–∑—ã–≤–∞–µ–º Python —Ñ—É–Ω–∫—Ü–∏—é
                const result = await pyodide.runPythonAsync(`
result = uvm_web.run("""${code.replace(/"/g, '\\"')}""")
import json
json.dumps(result)
`);

                const data = JSON.parse(result);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateOutput(data);

                document.getElementById('status').innerHTML =
                    `‚úÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.logs.length} –∫–æ–º–∞–Ω–¥.`;

            } catch (error) {
                document.getElementById('status').innerHTML =
                    `‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${error.message}`;

                document.getElementById('logOutput').textContent =
                    `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞
        function updateOutput(data) {
            // –†–µ–≥–∏—Å—Ç—Ä—ã
            let registersText = '';
            if (Object.keys(data.registers).length > 0) {
                for (const [reg, val] of Object.entries(data.registers)) {
                    registersText += `${reg}: ${val} (0x${val.toString(16).toUpperCase()})\\n`;
                }
            } else {
                registersText = '–í—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã –Ω—É–ª–µ–≤—ã–µ';
            }
            document.getElementById('registersOutput').textContent = registersText;

            // –ü–∞–º—è—Ç—å
            let memoryText = '';
            if (Object.keys(data.memory).length > 0) {
                for (const [addr, val] of Object.entries(data.memory)) {
                    memoryText += `${addr}: ${val} (0x${val.toString(16).toUpperCase()})\\n`;
                }
            } else {
                memoryText = '–ù–µ—Ç –Ω–µ–Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ –ø–∞–º—è—Ç–∏';
            }
            document.getElementById('memoryOutput').textContent = memoryText;

            // –õ–æ–≥–∏
            document.getElementById('logOutput').textContent = data.logs.join('\\n');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–∞
        function loadExample() {
            const example = `; –¢–µ—Å—Ç—ã –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –£–í–ú
LOAD 862, 19     ; –¢–µ—Å—Ç 1: A=84, B=862, C=19
LOAD 777, 11     ; –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è READ
LOAD 999, 0
STORE 777, 0
READ 43, 11      ; –¢–µ—Å—Ç 2: A=223, B=43, C=11
LOAD 12345, 60
STORE 955, 60    ; –¢–µ—Å—Ç 3: A=9, B=955, C=60
LOAD 0x00ABCDEF, 36
LOAD 8, 0
STORE 100, 0
LOAD 100, 48
ROTR 36, 48      ; –¢–µ—Å—Ç 4: A=213, B=36, C=48`;

            document.getElementById('codeEditor').value = example;
        }

        // –û—á–∏—Å—Ç–∫–∞
        function clearAll() {
            document.getElementById('codeEditor').value = '';
            document.getElementById('registersOutput').textContent =
                '–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...';
            document.getElementById('memoryOutput').textContent =
                '–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...';
            document.getElementById('logOutput').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            initPyodide();
        });
    </script>
</body>
</html>